# まとめると。ブログにするかな

# Azure Functions (Durable Functions) について触ってみた

※今回のサンプルはJavascriptで作成しています。

Functionsで利用できるDurable Functionsとはサーバレス環境でステートフル関数を記述できる拡張機能になります。
もう少し簡単に言うと「直列・並行処理、ワークフロー制御、補正トランザクション、タイマー処理など複雑になりがちなコーディングがより簡単・安全に実現できる拡張機能」となっています。  
Durable Functionsを利用することで、スケーラブルで安全なシステムが簡単に素早く実現できるようになっています。


公式ドキュメントで紹介されている [６つのアプリケーション パターン](https://docs.microsoft.com/ja-jp/azure/azure-functions/durable/durable-functions-overview?tabs=csharp#application-patterns "アプリケーション パターン") の実装例が非常に役に立ちました。 アプリケーションを実装するときによくあるパターンなので是非マスターしておきたいテクニックです。  

## 導入について
公式のドキュメントが十分に整備されているので基本的に公式のクイックスタートなどを動かしながら習得していくのが良いと思います。

## ６つのパターンの使いどころについて説明
パターンを簡単に纏めると下記のようになると思います。それぞれ必要なパターンを組み合わせて利用します。

| # |パターン名 | 簡単な説明・使いどころ |
| :--: | --- | --- |
| #1 | 関数チェーン | 順番に実行したい場合に利用する。ワークフローの実現。 |
| #2 | ファンアウト/ファンイン | 並列処理の実現 |
| #3 | 非同期 HTTP API | トランザクションの状態をクライアントにポーリングさせて実行時間の長い処理を調整するよくあるパターン。 <br>※オーケストレーター関数の状態をクエリするWebhook HTTP APIが組み込みサポートされており自分で実装する必要がない。 |
| #4 | モニター | 柔軟な監視処理 |
| #5 | 人による操作 | 別システムやクライアントなどからのイベントを待ち受けるパターン<br>タイマーを利用したワークフロー |
| #6 | アグリゲーター | データの集計<br>(※entityの利用) |

## 開発時気になったことや注意点
1. Azureの他のサービス(CosmosDBなど)との連携にはトリガーとバインドが多数用意されているのでできるだけそれを活用する  

2. Function Core Tool(CLI)での操作を習得すること (func xxx)

3. FunctionsはApplicaiton Insightと連携させて監視する  

4. Durable Functions は Azure Storage(Queue, Table) でタスク管理を行うため、Storage Accountが必要。Durable Functions 専用に用意する。

5. Linux カスタム コンテナーでも動作可能。（DurableがAKSで動かせなかった。。。）

6. Taskの監視にはEventGridを利用する

7. デプロイにはSlotを利用してTaskHubも一緒に変更するのがおすすめ




